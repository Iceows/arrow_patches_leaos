From ce60d2bb3c714e61a1b926730c9a807813105814 Mon Sep 17 00:00:00 2001
From: Raphael Mounier <mounierr07@gmail.com>
Date: Fri, 26 May 2023 09:47:03 +0200
Subject: [PATCH] treble : start charger with system user

Start charger with system user to fix none blank issues on kirin 710 and change owner of sysfs backlight and led for all phone model
---
 charger.rc          | 20 ++++++++++++++++++--
 sepolicy/charger.te | 12 ++++++++----
 2 files changed, 26 insertions(+), 6 deletions(-)

diff --git a/charger.rc b/charger.rc
index b52e93b..f3c5550 100644
--- a/charger.rc
+++ b/charger.rc
@@ -7,11 +7,27 @@ import /vendor/etc/init/${ro.bootmode}/init.${ro.bootmode}.rc
 
 service charger /system/bin/charger
     class charger
-    user root
-    group system root shell graphics input wakelock
+    user system
+    group root system shell graphics input wakelock
     capabilities SYS_BOOT
     seclabel u:r:charger:s0
 
+on init
+	chown system system /sys/class/leds/lcd_backlight0/brightness
+    chmod 644 /sys/class/leds/lcd_backlight0/brightness
+    chown system system /sys/class/leds/red/brightness
+    chown system system /sys/class/leds/red/delay_off
+    chown system system /sys/class/leds/red/delay_on
+    chown system system /sys/class/leds/green/brightness
+    chown system system /sys/class/leds/green/delay_off
+    chown system system /sys/class/leds/green/delay_on
+    chown system system /sys/class/leds/blue/brightness
+    chown system system /sys/class/leds/blue/delay_off
+    chown system system /sys/class/leds/blue/delay_on
+	
+
 on charger && property:ro.hardware=mt*
     write /sys/class/leds/lcd-backlight/trigger "backlight"
     write /sys/class/android_usb/android0/enable 1
+	
+
diff --git a/sepolicy/charger.te b/sepolicy/charger.te
index cbcb255..106ec4b 100644
--- a/sepolicy/charger.te
+++ b/sepolicy/charger.te
@@ -1,10 +1,14 @@
-# Allow charger to write to sysfs_backlight_attr (only for huawei)
+# Allow charger to write to sysfs_backlight_attr
 attribute sysfs_backlight_attr;
 allow charger sysfs_backlight_attr:file rw_file_perms;
 
-# Allow charger to write to sysfs_led_attr (only for huawei)
-# attribute sysfs_led_attr;
-# allow charger sysfs_led_attr:file rw_file_perms;
+# charger.rc init set backlight
+type sysfs_backlight, sysfs_type;
+allow init sysfs_backlight:file {open read write getattr setattr ioctl};
+
+# Allow charger to write to sysfs_led_attr
+attribute sysfs_led_attr;
+allow charger sysfs_led_attr:file rw_file_perms;
 
 # Allow charger to read and write to sysfs_power
 allow charger sysfs_power:file rw_file_perms;
-- 
2.25.1

